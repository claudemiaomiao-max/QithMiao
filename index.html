<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ChatGPT å¯¹è¯æŸ¥çœ‹å™¨</title>
  <style>
    :root {
      --primary: #e8b4b8;
      --primary-dark: #d4a5a5;
      --primary-light: #f5d5d8;
      --bg: #fdf6f6;
      --bg-card: #ffffff;
      --text: #5c4d4d;
      --text-light: #8a7a7a;
      --border: #f0e0e0;
      --user-bubble: #e8b4b8;
      --user-text: #ffffff;
      --ai-bubble: #f8f0f0;
      --ai-text: #5c4d4d;
      --star-active: #f0c14b;
      --heat-1: #fdf0f0;
      --heat-2: #f8d8d8;
      --heat-3: #f0b8b8;
      --heat-4: #e89898;
      --danger: #e57373;
      --danger-light: #ffebee;
      --system-bg: #faf6f1;
      --system-border: #d4c4b0;
      --system-text: #6b5344;
      --memory-bg: #f9f5f0;
      --memory-border: #c9b99a;
      --memory-text: #7a6652;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #fff3cd;
      --highlight-border: #ffdb70;
      --font-size-base: 0.9rem;
      --font-size-small: 0.8rem;
      --font-size-xs: 0.75rem;
      --line-height: 1.6;
    }
    [data-theme="brown"] {
      --primary: #b5a191;
      --primary-dark: #968272;
      --primary-light: #e0d6cc;
      --bg: #f7f4f1;
      --bg-card: #ffffff;
      --text: #5a524a;
      --text-light: #8c837a;
      --border: #e5ddd5;
      --user-bubble: #b5a191;
      --user-text: #ffffff;
      --ai-bubble: #f3eeea;
      --ai-text: #5a524a;
      --heat-1: #f5f0eb;
      --heat-2: #e8ded4;
      --heat-3: #d4c4b5;
      --heat-4: #b5a191;
      --danger: #c08070;
      --danger-light: #f9eeeb;
      --system-bg: #f3eeea;
      --system-border: #c5b8a8;
      --system-text: #6b5d50;
      --memory-bg: #f3eeea;
      --memory-border: #c5b8a8;
      --memory-text: #6b5d50;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #f5ecd8;
      --highlight-border: #d4c4a8;
    }
    [data-theme="blue"] {
      --primary: #94A0D3;
      --primary-dark: #7b89c4;
      --primary-light: #d8ddf0;
      --bg: #f5f6fa;
      --bg-card: #ffffff;
      --text: #4a4e69;
      --text-light: #7c8091;
      --border: #e0e3ef;
      --user-bubble: #94A0D3;
      --user-text: #ffffff;
      --ai-bubble: #eef0f8;
      --ai-text: #4a4e69;
      --heat-1: #f0f2f8;
      --heat-2: #d8ddf0;
      --heat-3: #b8c0e0;
      --heat-4: #94A0D3;
      --danger: #d47f8a;
      --danger-light: #faeef0;
      --system-bg: #eef0f8;
      --system-border: #b8c0e0;
      --system-text: #5a5e78;
      --memory-bg: #eef0f8;
      --memory-border: #b8c0e0;
      --memory-text: #5a5e78;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #e8ebf5;
      --highlight-border: #b8c0e0;
    }
    [data-theme="dark"] {
      --primary: #7c9db8;
      --primary-dark: #5a7a94;
      --primary-light: #3d4a54;
      --bg: #1a1d21;
      --bg-card: #252a30;
      --text: #e0e0e0;
      --text-light: #9a9a9a;
      --border: #3a3f46;
      --user-bubble: #5a7a94;
      --user-text: #ffffff;
      --ai-bubble: #2d3339;
      --ai-text: #e0e0e0;
      --heat-1: #252a30;
      --heat-2: #3d4a54;
      --heat-3: #5a7a94;
      --heat-4: #7c9db8;
      --danger: #cf6679;
      --danger-light: #3d2a2d;
      --system-bg: #2d3339;
      --system-border: #4a5568;
      --system-text: #b0b0b0;
      --memory-bg: #2d3339;
      --memory-border: #4a5568;
      --memory-text: #b0b0b0;
      --avatar-ai-bg: #3d4a54;
      --highlight-bg: #4a4a30;
      --highlight-border: #6a6a40;
    }
    [data-fontsize="small"] {
      --font-size-base: 0.8rem;
      --font-size-small: 0.7rem;
      --font-size-xs: 0.65rem;
      --line-height: 1.5;
    }
    [data-fontsize="large"] {
      --font-size-base: 1rem;
      --font-size-small: 0.9rem;
      --font-size-xs: 0.85rem;
      --line-height: 1.7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .icon-svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .icon-svg-fill { width: 20px; height: 20px; fill: currentColor; stroke: none; }
    .drawer-menu-item .icon-svg { width: 22px; height: 22px; }
    .title-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; fill: none; vertical-align: middle; margin-right: 6px; }
    .title-icon-fill { width: 24px; height: 24px; fill: var(--star-active); stroke: none; vertical-align: middle; margin-right: 6px; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .loading-overlay.show { opacity: 1; visibility: visible; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { margin-top: 16px; color: var(--text); font-size: var(--font-size-base); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9998; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal { background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
    .modal-overlay.show .modal { transform: scale(1); }
    .modal-icon { font-size: 3rem; margin-bottom: 12px; }
    .modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text); }
    .modal-message { font-size: var(--font-size-base); color: var(--text-light); margin-bottom: 20px; line-height: 1.5; white-space: pre-line; }
    .modal-buttons { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-size: var(--font-size-base); cursor: pointer; transition: all 0.2s; border: none; }
    .modal-btn.cancel { background: var(--bg); color: var(--text); }
    .modal-btn.confirm { background: var(--danger); color: white; }
    .modal-btn.primary { background: var(--primary); color: white; }
    .modal-btn:active { transform: scale(0.97); }
    .settings-panel { background: var(--bg-card); border-radius: 16px; padding: 20px; max-width: 340px; width: 90%; transform: scale(0.9); transition: transform 0.3s; }
    .modal-overlay.show .settings-panel { transform: scale(1); }
    .settings-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .settings-section { margin-bottom: 20px; }
    .settings-label { font-size: var(--font-size-small); color: var(--text-light); margin-bottom: 8px; display: block; }
    .settings-input { width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: var(--font-size-base); outline: none; transition: all 0.2s; background: var(--bg); color: var(--text); }
    .settings-input:focus { border-color: var(--primary); }
    .settings-row { display: flex; gap: 12px; }
    .settings-row .settings-field { flex: 1; }
    .theme-selector { display: flex; gap: 12px; justify-content: center; }
    .theme-dot { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; position: relative; }
    .theme-dot:hover { transform: scale(1.1); }
    .theme-dot.active { border-color: var(--text); }
    .theme-dot.active::after { content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 14px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .theme-dot.pink { background: linear-gradient(135deg, #e8b4b8 0%, #d4a5a5 100%); }
    .theme-dot.brown { background: linear-gradient(135deg, #b5a191 0%, #968272 100%); }
    .theme-dot.blue { background: linear-gradient(135deg, #94A0D3 0%, #7b89c4 100%); }
    .theme-dot.dark { background: linear-gradient(135deg, #3d4a54 0%, #1a1d21 100%); }
    .fontsize-selector { display: flex; gap: 8px; justify-content: center; }
    .fontsize-btn { padding: 8px 16px; border: 2px solid var(--border); border-radius: 20px; background: var(--bg); color: var(--text); font-size: var(--font-size-small); cursor: pointer; transition: all 0.2s; }
    .fontsize-btn:hover { border-color: var(--primary); }
    .fontsize-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .settings-buttons { display: flex; gap: 12px; margin-top: 24px; }
    .header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header-left { display: flex; align-items: center; gap: 6px; }
    .header-btn { width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-weight: 500; }
    .header-btn:hover { background: rgba(255,255,255,0.3); }
    .header-btn:active { transform: scale(0.95); }
    .header-btn .icon-svg { stroke: white; }
    .header-logo { font-size: 0.95rem; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.1); letter-spacing: 0.5px; white-space: nowrap; }
    @media (max-width: 380px) { .header-logo { font-size: 0.8rem; } }
    .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1001; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .drawer-overlay.show { opacity: 1; visibility: visible; }
    .drawer { position: fixed; top: 0; left: 0; width: 300px; max-width: 85vw; height: 100%; background: var(--bg-card); z-index: 1002; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; }
    .drawer.show { transform: translateX(0); }
    .drawer-header { padding: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
    .drawer-header h2 { font-size: 1.1rem; font-weight: 500; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    .drawer-header p { font-size: var(--font-size-xs); opacity: 0.9; }
    .drawer-menu { display: flex; padding: 8px 10px; gap: 4px; border-bottom: 1px solid var(--border); background: var(--bg); }
    .drawer-menu-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px 2px; cursor: pointer; transition: all 0.2s; border-radius: 8px; gap: 3px; color: var(--text); }
    .drawer-menu-item:hover { background: var(--primary-light); }
    .drawer-menu-item.active { background: var(--primary-light); color: var(--primary-dark); }
    .drawer-menu-item .label { font-size: 0.6rem; white-space: nowrap; }
    .drawer-menu-item.danger { color: var(--danger); }
    .drawer-menu-item.danger:hover { background: var(--danger-light); }
    .conv-actions { display: flex; align-items: center; padding: 8px 10px; gap: 6px; border-bottom: 1px solid var(--border); }
    .conv-action-btn { flex: 1; padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 3px; color: var(--text); }
    .conv-action-btn:hover { background: var(--primary-light); border-color: var(--primary); }
    .conv-action-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .conv-action-btn.danger { color: var(--danger); }
    .conv-action-btn.danger:hover { background: var(--danger-light); border-color: var(--danger); }
    .conv-search { padding: 8px 10px; }
    .conv-search input { width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 10px; font-size: var(--font-size-small); outline: none; transition: all 0.2s; background: var(--bg); color: var(--text); }
    .conv-search input:focus { border-color: var(--primary); }
    .conv-search input::placeholder { color: var(--text-light); }
    .drawer-conversations { flex: 1; overflow-y: auto; padding: 8px 10px; }
    .conv-item { padding: 10px 12px; border-radius: 10px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; background: var(--bg); display: flex; align-items: flex-start; gap: 8px; }
    .conv-item:hover { border-color: var(--primary-light); }
    .conv-item.active { border-color: var(--primary); background: var(--primary-light); }
    .conv-item.selected { border-color: var(--primary); background: var(--primary-light); }
    .conv-checkbox { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 4px; display: none; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; background: white; transition: all 0.2s; font-size: 0.7rem; }
    .conv-checkbox.show { display: flex; }
    .conv-checkbox.checked { background: var(--primary); border-color: var(--primary); color: white; }
    .conv-info { flex: 1; min-width: 0; }
    .conv-item .conv-title { font-size: var(--font-size-small); font-weight: 500; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-item .conv-meta { font-size: var(--font-size-xs); color: var(--text-light); line-height: 1.4; }
    .conv-delete-btn { width: 24px; height: 24px; border: none; background: transparent; color: var(--text-light); border-radius: 6px; cursor: pointer; display: none; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; font-size: 1rem; }
    .conv-item:hover .conv-delete-btn { display: flex; }
    .conv-delete-btn:hover { background: var(--danger-light); color: var(--danger); }
    .main-content { padding-top: 56px; min-height: 100vh; background: var(--bg); }
    .view-upload { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 56px); padding: 20px; }
    .upload-box { background: var(--bg-card); border-radius: 24px; padding: 50px 40px; text-align: center; border: 3px dashed var(--primary-light); max-width: 400px; width: 100%; transition: all 0.3s; }
    .upload-box.dragover { border-color: var(--primary); background: var(--primary-light); }
    .upload-box .icon { font-size: 4rem; margin-bottom: 16px; }
    .upload-box h2 { font-size: 1.2rem; color: var(--text); margin-bottom: 8px; font-weight: 500; }
    .upload-box p { font-size: var(--font-size-small); color: var(--text-light); margin-bottom: 24px; }
    .upload-btn { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; padding: 14px 32px; border-radius: 25px; font-size: 1rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(232, 180, 184, 0.4); }
    .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(232, 180, 184, 0.5); }
    #file-input { display: none; }
    .upload-hint { margin-top: 20px; padding: 12px 16px; background: var(--primary-light); border-radius: 12px; font-size: var(--font-size-small); color: var(--text); }
    .view-chat { display: none; flex-direction: column; height: calc(100vh - 56px); }
    .view-chat.show { display: flex; }
    .chat-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .chat-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .chat-title { font-size: 1rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .collapse-btn { width: 28px; height: 28px; border: none; background: var(--bg); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-light); font-size: 0.8rem; margin-left: 8px; flex-shrink: 0; }
    .collapse-btn:hover { background: var(--primary-light); color: var(--primary-dark); }
    .collapse-btn.collapsed { transform: rotate(180deg); }
    .collapsible-section { transition: all 0.3s ease; overflow: hidden; }
    .collapsible-section.collapsed { height: 0 !important; padding: 0 !important; margin: 0 !important; opacity: 0; }
    .search-section { margin-bottom: 8px; }
    .search-box { position: relative; }
    .search-box input { width: 100%; padding: 10px 16px 10px 40px; border: 2px solid var(--border); border-radius: 20px; font-size: var(--font-size-base); outline: none; transition: all 0.2s; background: var(--bg); color: var(--text); }
    .search-box input:focus { border-color: var(--primary); background: var(--bg-card); }
    .search-box input::placeholder { color: var(--text-light); }
    .search-box .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
    .search-mode-toggle { display: flex; gap: 4px; margin-top: 8px; }
    .search-mode-btn { flex: 1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 15px; background: var(--bg); font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; color: var(--text); }
    .search-mode-btn:hover { border-color: var(--primary); }
    .search-mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .global-search-info { display: none; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--primary-light); border-radius: 10px; margin-top: 8px; font-size: var(--font-size-small); }
    .global-search-info.show { display: flex; }
    .search-result-count { color: var(--primary-dark); font-weight: 500; }
    .search-nav-btns { display: flex; gap: 4px; }
    .search-nav-btn { padding: 4px 10px; border: 1px solid var(--primary); border-radius: 12px; background: white; font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; color: var(--primary-dark); }
    .search-nav-btn:hover { background: var(--primary); color: white; }
    .timeline-nav { display: none; padding: 10px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); overflow-x: auto; white-space: nowrap; gap: 8px; }
    .timeline-nav.show { display: flex; }
    .timeline-nav.collapsed { display: none !important; }
    .timeline-btn { display: inline-block; padding: 6px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 15px; font-size: var(--font-size-small); color: var(--text); cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
    .timeline-btn:hover { background: var(--primary-light); border-color: var(--primary); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); }
    .date-divider { text-align: center; margin: 20px 0; position: relative; }
    .date-divider span { background: var(--bg); padding: 4px 16px; font-size: var(--font-size-small); color: var(--text-light); border-radius: 12px; }
    .conv-group-title { background: var(--primary-light); padding: 8px 14px; border-radius: 10px; margin: 16px 0 12px; font-size: var(--font-size-small); font-weight: 500; color: var(--primary-dark); display: flex; align-items: center; gap: 6px; }
    .message { display: flex; margin-bottom: 16px; align-items: flex-start; }
    .message.user { flex-direction: row-reverse; }
    .message-avatar-wrapper { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
    .message.user .message-avatar-wrapper { margin-left: 10px; }
    .message.assistant .message-avatar-wrapper, .message.system .message-avatar-wrapper, .message.memory .message-avatar-wrapper { margin-right: 10px; }
    .message-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; background: var(--bg); }
    .message.user .message-avatar { background: var(--primary-light); }
    .message.assistant .message-avatar { background: var(--avatar-ai-bg); }
    .message.system .message-avatar { background: var(--system-bg); }
    .message.memory .message-avatar { background: var(--memory-bg); }
    .avatar-name { font-size: 0.55rem; color: var(--text-light); margin-top: 4px; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
    .message-body { max-width: 75%; position: relative; }
    .message-bubble { padding: 12px 16px; border-radius: 18px; line-height: var(--line-height); font-size: var(--font-size-base); word-break: break-word; white-space: pre-wrap; }
    .message.user .message-bubble { background: var(--user-bubble); color: var(--user-text); border-bottom-right-radius: 6px; }
    .message.assistant .message-bubble { background: var(--ai-bubble); color: var(--ai-text); border-bottom-left-radius: 6px; }
    .message.highlight .message-bubble { box-shadow: 0 0 0 3px var(--primary); }
    
    /* â˜… å…³é”®è¯é«˜äº®æ ·å¼ - ç”¨äºæ¶ˆæ¯æ°”æ³¡å†…çš„æœç´¢å…³é”®è¯ */
    .highlight-text { background: var(--highlight-bg); padding: 1px 2px; border-radius: 2px; }
    .message-bubble .highlight {
      background: var(--highlight-bg);
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid var(--highlight-border);
      font-weight: 500;
    }
    .search-result-preview .highlight { 
      background: var(--highlight-bg); 
      padding: 1px 3px; 
      border-radius: 2px; 
      font-weight: 500; 
    }
    
    .message.system .message-bubble { background: var(--system-bg); color: var(--system-text); border: 1px solid var(--system-border); border-bottom-left-radius: 6px; }
    .message.system .message-bubble .system-label { display: inline-block; background: var(--system-border); color: white; padding: 2px 8px; border-radius: 4px; font-size: var(--font-size-xs); margin-bottom: 8px; font-weight: 500; }
    .message.memory .message-bubble { background: var(--memory-bg); color: var(--memory-text); border: 1px solid var(--memory-border); border-bottom-left-radius: 6px; }
    .message.memory .message-bubble .memory-label { display: inline-block; background: var(--memory-border); color: white; padding: 2px 8px; border-radius: 4px; font-size: var(--font-size-xs); margin-bottom: 8px; font-weight: 500; }
    .message-footer { display: flex; align-items: center; gap: 8px; margin-top: 4px; padding: 0 4px; flex-wrap: wrap; }
    .message.user .message-footer { flex-direction: row-reverse; }
    .message-time { font-size: var(--font-size-xs); color: var(--text-light); }
    .message-model { font-size: 0.65rem; color: var(--primary-dark); background: var(--primary-light); padding: 2px 6px; border-radius: 4px; }
    .star-btn { background: none; border: none; cursor: pointer; font-size: 1rem; opacity: 0.4; transition: all 0.2s; padding: 2px; }
    .star-btn:hover { opacity: 0.8; }
    .star-btn.active { opacity: 1; color: var(--star-active); }
    .view-global-search { display: none; flex-direction: column; height: calc(100vh - 56px); }
    .view-global-search.show { display: flex; }
    .global-search-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .global-search-title { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .global-search-title h2 { font-size: 1rem; font-weight: 500; flex: 1; }
    .global-search-back { width: 32px; height: 32px; border: none; background: var(--bg); border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text); }
    .global-search-back:hover { background: var(--primary-light); }
    .global-search-stats { font-size: var(--font-size-small); color: var(--text-light); }
    .global-search-results { flex: 1; overflow-y: auto; padding: 12px 16px; }
    .search-result-item { background: var(--bg-card); border-radius: 12px; padding: 12px 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .search-result-item:hover { border-color: var(--primary-light); }
    .search-result-conv-title { font-size: var(--font-size-small); font-weight: 500; color: var(--primary-dark); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .search-result-count-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: var(--font-size-xs); font-weight: normal; }
    .search-result-preview { font-size: var(--font-size-small); color: var(--text); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .search-result-meta { font-size: var(--font-size-xs); color: var(--text-light); margin-top: 6px; }
    .view-favorites { display: none; flex-direction: column; height: calc(100vh - 56px); }
    .view-favorites.show { display: flex; }
    .favorites-header { padding: 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .favorites-header .view-title { margin-bottom: 12px; }
    .favorites-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .fav-action-btn { padding: 8px 14px; border: 1px solid var(--border); border-radius: 20px; background: var(--bg); font-size: var(--font-size-small); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px; color: var(--text); }
    .fav-action-btn:hover { background: var(--primary-light); border-color: var(--primary); }
    .fav-action-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .fav-action-btn.export { background: var(--primary); color: white; border-color: var(--primary); }
    .fav-action-btn.export:hover { background: var(--primary-dark); }
    .fav-action-btn.danger { color: var(--danger); border-color: var(--danger); }
    .fav-action-btn.danger:hover { background: var(--danger-light); }
    .favorites-list { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); }
    .fav-msg-checkbox { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%; display: none; align-items: center; justify-content: center; flex-shrink: 0; background: white; transition: all 0.2s; font-size: 0.7rem; cursor: pointer; margin-right: 8px; }
    .fav-msg-checkbox.show { display: flex; }
    .fav-msg-checkbox.checked { background: var(--primary); border-color: var(--primary); color: white; }
    .view-title { font-size: 1.2rem; font-weight: 500; padding-bottom: 12px; border-bottom: 2px solid var(--primary-light); display: flex; align-items: center; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-state .icon { font-size: 3.5rem; margin-bottom: 12px; }
    .view-stats { display: none; padding: 16px; overflow-y: auto; height: calc(100vh - 56px); background: var(--bg); }
    .view-stats.show { display: block; }
    .stats-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .month-nav { display: flex; align-items: center; gap: 12px; }
    .month-nav button { background: var(--bg-card); border: 1px solid var(--border); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1rem; transition: all 0.2s; color: var(--text); }
    .month-nav button:hover { background: var(--primary-light); border-color: var(--primary); }
    .month-nav .month-label { font-size: 1rem; font-weight: 500; min-width: 120px; text-align: center; }
    .calendar { background: var(--bg-card); border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-weekdays span { text-align: center; font-size: var(--font-size-xs); color: var(--text-light); padding: 8px 0; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; font-size: var(--font-size-small); cursor: pointer; transition: all 0.2s; background: var(--bg); }
    .calendar-day:hover { transform: scale(1.05); }
    .calendar-day.empty { background: transparent; cursor: default; }
    .calendar-day.empty:hover { transform: none; }
    .calendar-day .day-num { font-weight: 500; }
    .calendar-day .day-words { font-size: 0.6rem; color: var(--text-light); margin-top: 2px; }
    .calendar-day.heat-1 { background: var(--heat-1); }
    .calendar-day.heat-2 { background: var(--heat-2); }
    .calendar-day.heat-3 { background: var(--heat-3); }
    .calendar-day.heat-4 { background: var(--heat-4); color: white; }
    .calendar-day.heat-4 .day-words { color: rgba(255,255,255,0.8); }
    .stats-summary { margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-card { background: var(--bg-card); border-radius: 12px; padding: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .stat-card .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
    .stat-card .stat-label { font-size: var(--font-size-small); color: var(--text-light); margin-top: 4px; }
    .view-timeline { display: none; padding: 16px; overflow-y: auto; height: calc(100vh - 56px); background: var(--bg); }
    .view-timeline.show { display: block; }
    .timeline-list { background: var(--bg-card); border-radius: 16px; overflow: hidden; }
    .timeline-date-item { display: flex; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .timeline-date-item:last-child { border-bottom: none; }
    .timeline-date-item:hover { background: var(--bg); }
    .timeline-date-item .date { font-weight: 500; flex: 1; }
    .timeline-date-item .count { font-size: var(--font-size-small); color: var(--text-light); }
    
    /* â˜… æ–°å¢ï¼šçª—å£é€‰æ‹©é¡µæ ·å¼ */
    .view-conv-select { display: none; flex-direction: column; height: calc(100vh - 56px); }
    .view-conv-select.show { display: flex; }
    .conv-select-list { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); }
    .conv-select-item { display: flex; align-items: center; padding: 14px 16px; background: var(--bg-card); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .conv-select-item:hover { border-color: var(--primary-light); transform: translateX(4px); }
    .conv-select-item:active { transform: scale(0.98); }
    .conv-select-item .conv-icon { font-size: 1.5rem; margin-right: 12px; }
    .conv-select-item .conv-detail { flex: 1; min-width: 0; }
    .conv-select-item .conv-name { font-size: var(--font-size-base); font-weight: 500; color: var(--text); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-select-item .conv-stats { font-size: var(--font-size-xs); color: var(--text-light); }
    .conv-select-item .conv-arrow { color: var(--text-light); font-size: 1.2rem; }
    
    .view-day-messages { display: none; flex-direction: column; height: calc(100vh - 56px); }
    .view-day-messages.show { display: flex; }
    .day-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .day-back-btn { width: 36px; height: 36px; border: none; background: var(--bg); border-radius: 10px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text); }
    .day-back-btn:hover { background: var(--primary-light); }
    .day-title { flex: 1; }
    .day-title h2 { font-size: 1rem; font-weight: 500; margin-bottom: 2px; }
    .day-title p { font-size: var(--font-size-xs); color: var(--text-light); }
    .day-messages { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); }
    .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(92, 77, 77, 0.9); color: white; padding: 12px 24px; border-radius: 25px; font-size: var(--font-size-base); z-index: 9999; opacity: 0; transition: all 0.3s; }
    [data-theme="dark"] .toast { background: rgba(200, 200, 200, 0.9); color: #1a1d21; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    @media (max-width: 480px) { .header-logo { font-size: 0.85rem; } .message-body { max-width: 85%; } .upload-box { padding: 30px 20px; } }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div><div class="loading-text" id="loading-text">åŠ è½½ä¸­...</div></div>
  <div class="modal-overlay" id="modal-overlay"><div class="modal"><div class="modal-icon" id="modal-icon">âš ï¸</div><div class="modal-title" id="modal-title">ç¡®è®¤æ“ä½œ</div><div class="modal-message" id="modal-message">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div><div class="modal-buttons"><button class="modal-btn confirm" id="modal-confirm-btn" onclick="confirmModalAction()">ç¡®å®š</button><button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button></div></div></div>
  <div class="modal-overlay" id="settings-overlay"><div class="settings-panel"><div class="settings-title"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>è®¾ç½®</div><div class="settings-section"><label class="settings-label">æ˜µç§°è®¾ç½®</label><div class="settings-row"><div class="settings-field"><input type="text" class="settings-input" id="settings-user-name" placeholder="ç”¨æˆ·æ˜µç§°"></div><div class="settings-field"><input type="text" class="settings-input" id="settings-ai-name" placeholder="åŠ©æ‰‹æ˜µç§°"></div></div></div><div class="settings-section"><label class="settings-label">ä¸»é¢˜é¢œè‰²</label><div class="theme-selector"><div class="theme-dot pink active" data-theme="pink" onclick="selectTheme('pink')" title="æ¨±èŠ±ç²‰"></div><div class="theme-dot brown" data-theme="brown" onclick="selectTheme('brown')" title="å¥¶èŒ¶æ£•"></div><div class="theme-dot blue" data-theme="blue" onclick="selectTheme('blue')" title="é›¾éœ¾è“"></div><div class="theme-dot dark" data-theme="dark" onclick="selectTheme('dark')" title="å¤œé—´æ¨¡å¼"></div></div></div><div class="settings-section"><label class="settings-label">å­—ä½“å¤§å°</label><div class="fontsize-selector"><button class="fontsize-btn" data-size="small" onclick="selectFontSize('small')">å°</button><button class="fontsize-btn active" data-size="medium" onclick="selectFontSize('medium')">ä¸­</button><button class="fontsize-btn" data-size="large" onclick="selectFontSize('large')">å¤§</button></div></div><div class="settings-buttons"><button class="modal-btn primary" onclick="saveSettings()">ä¿å­˜</button><button class="modal-btn cancel" onclick="closeSettings()">å–æ¶ˆ</button></div></div></div>
  <div class="toast" id="toast"></div>
  <header class="header"><div class="header-left"><button class="header-btn" onclick="toggleDrawer()"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><button class="header-btn" onclick="document.getElementById('file-input').click()"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button></div><div class="header-logo" id="header-logo">ChatGPT å¯¹è¯æŸ¥çœ‹å™¨</div><input type="file" id="file-input" accept=".json" multiple onchange="handleFileSelect(event)"></header>
  <div class="drawer-overlay" id="drawer-overlay" onclick="toggleDrawer()"></div>
  <nav class="drawer" id="drawer"><div class="drawer-header"><h2 id="drawer-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span id="drawer-title-text">æˆ‘ä»¬çš„å›å¿†</span></h2><p id="drawer-subtitle">è¿˜æ²¡æœ‰ä¸Šä¼ å¯¹è¯å“¦~</p></div><div class="drawer-menu"><div class="drawer-menu-item active" data-view="conversations" onclick="switchView('conversations')"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span class="label">å¯¹è¯</span></div><div class="drawer-menu-item" data-view="favorites" onclick="switchView('favorites')"><svg class="icon-svg" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><span class="label">æ”¶è—</span></div><div class="drawer-menu-item" data-view="stats" onclick="switchView('stats')"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="label">ç»Ÿè®¡</span></div><div class="drawer-menu-item" data-view="timeline" onclick="switchView('timeline')"><svg class="icon-svg" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="label">æ—¶é—´è½´</span></div><div class="drawer-menu-item" onclick="openSettings()"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span class="label">è®¾ç½®</span></div><div class="drawer-menu-item danger" onclick="showClearDataModal()"><svg class="icon-svg" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span class="label">æ¸…é™¤</span></div></div><div class="conv-actions" id="conv-actions"><button class="conv-action-btn" id="select-mode-btn" onclick="toggleSelectMode()">â˜‘ å¤šé€‰</button><button class="conv-action-btn" id="export-selected-btn" onclick="exportSelectedConversations()" style="display:none;">ğŸ“¤ å¯¼å‡º</button><button class="conv-action-btn danger" id="delete-selected-btn" onclick="showDeleteSelectedModal()" style="display:none;">ğŸ—‘ åˆ é™¤</button></div><div class="conv-search"><input type="text" id="conv-search-input" placeholder="ğŸ” æœç´¢å¯¹è¯æ ‡é¢˜..." oninput="filterConversations()"></div><div class="drawer-conversations" id="drawer-conversations"><div class="empty-state"><div class="icon">ğŸ“­</div><p>ä¸Šä¼ JSONåè¿™é‡Œä¼šæ˜¾ç¤ºå¯¹è¯åˆ—è¡¨~</p></div></div></nav>
  <main class="main-content">
    <div class="view-upload" id="view-upload"><div class="upload-box" id="upload-box"><div class="icon">ğŸ“</div><h2>ä¸Šä¼ ä½ çš„å¯¹è¯è®°å½•</h2><p>æ‹–æ‹½ ChatGPT å¯¼å‡ºçš„ JSON æ–‡ä»¶åˆ°è¿™é‡Œ<br>æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p><button class="upload-btn" onclick="document.getElementById('file-input').click()">âœ¨ é€‰æ‹©æ–‡ä»¶</button><div class="upload-hint">ğŸ’¡ æ”¯æŒå¤šæ¬¡ä¸Šä¼ ï¼Œä¼šè‡ªåŠ¨å»é‡åˆå¹¶å“¦~<br>ğŸ“ æ”¹åçš„å¯¹è¯ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ›´æ–°</div></div></div>
    <div class="view-chat" id="view-chat"><div class="chat-header" id="chat-header"><div class="chat-title-row"><div class="chat-title" id="chat-title">å¯¹è¯æ ‡é¢˜</div><button class="collapse-btn" id="collapse-btn" onclick="toggleHeaderCollapse()" title="æŠ˜å /å±•å¼€">â–²</button></div><div class="collapsible-section" id="collapsible-section"><div class="search-section"><div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" id="search-input" placeholder="æœç´¢æ¶ˆæ¯å†…å®¹..."></div><div class="search-mode-toggle"><button class="search-mode-btn active" data-mode="current" onclick="setSearchMode('current')">å½“å‰å¯¹è¯</button><button class="search-mode-btn" data-mode="global" onclick="setSearchMode('global')">å…¨éƒ¨å¯¹è¯</button></div><div class="global-search-info" id="global-search-info"><span class="search-result-count" id="search-result-count">æ‰¾åˆ° 0 æ¡ç»“æœ</span><div class="search-nav-btns"><button class="search-nav-btn" onclick="navigateSearchResult(-1)">â—€ ä¸Šä¸€ä¸ª</button><button class="search-nav-btn" onclick="navigateSearchResult(1)">ä¸‹ä¸€ä¸ª â–¶</button></div></div></div></div></div><div class="timeline-nav" id="timeline-nav"></div><div class="chat-messages" id="chat-messages"></div></div>
    <div class="view-global-search" id="view-global-search"><div class="global-search-header"><div class="global-search-title"><button class="global-search-back" onclick="exitGlobalSearch()">â†</button><h2>ğŸ” å…¨å±€æœç´¢ç»“æœ</h2></div><div class="global-search-stats" id="global-search-stats">æœç´¢ä¸­...</div></div><div class="global-search-results" id="global-search-results"><div class="empty-state"><div class="icon">ğŸ”</div><p>è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢~</p></div></div></div>
    
    <!-- â˜… æ–°å¢ï¼šçª—å£é€‰æ‹©é¡µ -->
    <div class="view-conv-select" id="view-conv-select">
      <div class="day-header">
        <button class="day-back-btn" onclick="switchView('timeline')">â†</button>
        <div class="day-title">
          <h2 id="conv-select-title">2024å¹´1æœˆ1æ—¥</h2>
          <p id="conv-select-subtitle">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„å¯¹è¯çª—å£</p>
        </div>
      </div>
      <div class="conv-select-list" id="conv-select-list"></div>
    </div>
    
    <div class="view-day-messages" id="view-day-messages"><div class="day-header"><button class="day-back-btn" onclick="backToConvSelect()">â†</button><div class="day-title"><h2 id="day-messages-title">2024å¹´1æœˆ1æ—¥</h2><p id="day-messages-subtitle">å…± 0 æ¡æ¶ˆæ¯</p></div></div><div class="day-messages" id="day-messages-container"></div></div>
    <div class="view-favorites" id="view-favorites"><div class="favorites-header"><h2 class="view-title"><svg class="title-icon-fill" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>æ”¶è—çš„æ¶ˆæ¯</h2><div class="favorites-actions"><button class="fav-action-btn" id="fav-select-btn" onclick="toggleFavSelectMode()">â˜‘ å¤šé€‰</button><button class="fav-action-btn" id="fav-select-all-btn" onclick="selectAllFavorites()" style="display:none;">å…¨é€‰</button><button class="fav-action-btn danger" id="fav-unfav-all-btn" onclick="unfavoriteSelected()" style="display:none;">ğŸ—‘ å–æ¶ˆæ”¶è—</button><button class="fav-action-btn export" id="fav-export-btn" onclick="exportSelectedFavorites()" style="display:none;">ğŸ“¤ å¯¼å‡ºé€‰ä¸­</button></div></div><div class="favorites-list" id="favorites-list"><div class="empty-state"><div class="icon">â­</div><p>è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ¶ˆæ¯~<br>åœ¨èŠå¤©ä¸­ç‚¹å‡»â˜†æ¥æ”¶è—å§</p></div></div></div>
    <div class="view-stats" id="view-stats"><h2 class="view-title"><svg class="title-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>èŠå¤©ç»Ÿè®¡</h2><div class="stats-header"><div class="month-nav"><button onclick="changeMonth(-1)">â—€</button><span class="month-label" id="month-label">2024å¹´1æœˆ</span><button onclick="changeMonth(1)">â–¶</button></div></div><div class="calendar"><div class="calendar-weekdays"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div><div class="calendar-days" id="calendar-days"></div></div><div class="stats-summary"><div class="stat-card"><div class="stat-value" id="stat-total-words">0</div><div class="stat-label">æœ¬æœˆæ€»å­—æ•°</div></div><div class="stat-card"><div class="stat-value" id="stat-total-days">0</div><div class="stat-label">èŠå¤©å¤©æ•°</div></div></div></div>
    <div class="view-timeline" id="view-timeline"><h2 class="view-title"><svg class="title-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>æŒ‰æ—¥æœŸè·³è½¬</h2><div class="timeline-list" id="timeline-list"></div></div>
  </main>
  <script>
    const DB_NAME = 'QithMiaoMiaoLogs';
    const DB_VERSION = 2;
    let db = null;
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains('conversations')) database.createObjectStore('conversations', { keyPath: 'id' });
          if (!database.objectStoreNames.contains('favorites')) database.createObjectStore('favorites', { keyPath: 'id' });
          if (!database.objectStoreNames.contains('metadata')) database.createObjectStore('metadata', { keyPath: 'key' });
        };
      });
    }
    async function saveConversationToDb(conv) { return new Promise((resolve, reject) => { const t = db.transaction(['conversations'], 'readwrite'); const s = t.objectStore('conversations'); const r = s.put(conv); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function deleteConversationFromDb(convId) { return new Promise((resolve, reject) => { const t = db.transaction(['conversations'], 'readwrite'); const s = t.objectStore('conversations'); const r = s.delete(convId); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function getAllConversationsFromDb() { return new Promise((resolve, reject) => { const t = db.transaction(['conversations'], 'readonly'); const s = t.objectStore('conversations'); const r = s.getAll(); r.onsuccess = () => resolve(r.result || []); r.onerror = () => reject(r.error); }); }
    async function saveFavoriteToDb(msgId) { return new Promise((resolve, reject) => { const t = db.transaction(['favorites'], 'readwrite'); const s = t.objectStore('favorites'); const r = s.put({ id: msgId }); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function removeFavoriteFromDb(msgId) { return new Promise((resolve, reject) => { const t = db.transaction(['favorites'], 'readwrite'); const s = t.objectStore('favorites'); const r = s.delete(msgId); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function getAllFavoritesFromDb() { return new Promise((resolve, reject) => { const t = db.transaction(['favorites'], 'readonly'); const s = t.objectStore('favorites'); const r = s.getAll(); r.onsuccess = () => { const results = r.result || []; resolve(new Set(results.map(x => x.id))); }; r.onerror = () => reject(r.error); }); }
    async function clearAllDataFromDb() { return new Promise((resolve, reject) => { const t = db.transaction(['conversations', 'favorites', 'metadata'], 'readwrite'); t.objectStore('conversations').clear(); t.objectStore('favorites').clear(); t.objectStore('metadata').clear(); t.oncomplete = () => resolve(); t.onerror = () => reject(t.error); }); }

    let allConversations = [], filteredConversations = [], conversationStats = {}, currentConvIndex = -1, currentConvId = null, currentMessages = [], allMessages = [], messagesByDate = {}, favorites = new Set(), statsByDate = {};
    let currentYear = new Date().getFullYear(), currentMonth = new Date().getMonth();
    let isSelectMode = false, selectedConvIds = new Set(), isFavSelectMode = false, selectedFavMsgIds = new Set(), modalConfirmCallback = null;
    let searchMode = 'current', globalSearchResults = [], currentSearchResultIndex = -1, flatSearchResults = [], isHeaderCollapsed = false;
    let appSettings = { userName: '', aiName: '', theme: 'pink', fontSize: 'medium' };
    
    // â˜… ç”¨äºä¿å­˜æœç´¢å…³é”®è¯å’ŒIMEè¾“å…¥çŠ¶æ€
    let currentSearchKeyword = '';
    let isComposing = false;

    document.addEventListener('DOMContentLoaded', async () => {
      showLoading('æ­£åœ¨åˆå§‹åŒ–...');
      try { loadSettings(); applySettings(); await openDatabase(); await loadFromDatabase(); setupDragDrop(); setupSearchInput(); } catch (e) { console.error('åˆå§‹åŒ–å¤±è´¥', e); showToast('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•'); }
      hideLoading();
    });

    // â˜… è®¾ç½®æœç´¢è¾“å…¥æ¡†çš„äº‹ä»¶ç›‘å¬ï¼ˆä¿®å¤IMEé—®é¢˜ï¼‰
    function setupSearchInput() {
      const searchInput = document.getElementById('search-input');
      if (!searchInput) return;
      
      // ç›‘å¬IMEç»„åˆå¼€å§‹
      searchInput.addEventListener('compositionstart', () => {
        isComposing = true;
      });
      
      // ç›‘å¬IMEç»„åˆç»“æŸ
      searchInput.addEventListener('compositionend', (e) => {
        isComposing = false;
        // ç»„åˆç»“æŸåè§¦å‘æœç´¢
        handleSearch();
      });
      
      // ç›‘å¬è¾“å…¥äº‹ä»¶
      searchInput.addEventListener('input', (e) => {
        // å¦‚æœæ­£åœ¨IMEç»„åˆä¸­ï¼Œä¸è§¦å‘æœç´¢
        if (isComposing) return;
        handleSearch();
      });
    }

    function loadSettings() { try { const saved = localStorage.getItem('chatLogViewerSettings'); if (saved) appSettings = { ...appSettings, ...JSON.parse(saved) }; } catch (e) { console.error('åŠ è½½è®¾ç½®å¤±è´¥', e); } }
    function saveSettingsToStorage() { try { localStorage.setItem('chatLogViewerSettings', JSON.stringify(appSettings)); } catch (e) { console.error('ä¿å­˜è®¾ç½®å¤±è´¥', e); } }
    function applySettings() {
      if (appSettings.theme === 'pink') document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme', appSettings.theme);
      if (appSettings.fontSize === 'medium') document.body.removeAttribute('data-fontsize'); else document.body.setAttribute('data-fontsize', appSettings.fontSize);
      updateHeaderLogo(); updatePageTitle();
    }
    function updateHeaderLogo() {
      const logo = document.getElementById('header-logo'), dt = document.getElementById('drawer-title-text');
      if (appSettings.userName && appSettings.aiName) { logo.textContent = `${appSettings.userName} & ${appSettings.aiName} Logs`; dt.textContent = `${appSettings.userName} & ${appSettings.aiName}`; }
      else if (appSettings.userName) { logo.textContent = `${appSettings.userName}'s Chat Logs`; dt.textContent = `${appSettings.userName}çš„å›å¿†`; }
      else if (appSettings.aiName) { logo.textContent = `${appSettings.aiName} Chat Logs`; dt.textContent = `ä¸${appSettings.aiName}çš„å›å¿†`; }
      else { logo.textContent = 'ChatGPT å¯¹è¯æŸ¥çœ‹å™¨'; dt.textContent = 'æˆ‘ä»¬çš„å›å¿†'; }
    }
    function updatePageTitle() { document.title = (appSettings.userName && appSettings.aiName) ? `${appSettings.userName} & ${appSettings.aiName} Logs` : 'ChatGPT å¯¹è¯æŸ¥çœ‹å™¨'; }
    function openSettings() {
      document.getElementById('settings-user-name').value = appSettings.userName;
      document.getElementById('settings-ai-name').value = appSettings.aiName;
      document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.theme === appSettings.theme));
      document.querySelectorAll('.fontsize-btn').forEach(b => b.classList.toggle('active', b.dataset.size === appSettings.fontSize));
      document.getElementById('settings-overlay').classList.add('show'); toggleDrawer(false);
    }
    function closeSettings() { document.getElementById('settings-overlay').classList.remove('show'); }
    function selectTheme(theme) { document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.theme === theme)); appSettings.theme = theme; if (theme === 'pink') document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme', theme); }
    function selectFontSize(size) { document.querySelectorAll('.fontsize-btn').forEach(b => b.classList.toggle('active', b.dataset.size === size)); appSettings.fontSize = size; if (size === 'medium') document.body.removeAttribute('data-fontsize'); else document.body.setAttribute('data-fontsize', size); }
    function saveSettings() { appSettings.userName = document.getElementById('settings-user-name').value.trim(); appSettings.aiName = document.getElementById('settings-ai-name').value.trim(); saveSettingsToStorage(); applySettings(); if (currentMessages.length > 0) renderMessages(currentMessages); closeSettings(); showToast('è®¾ç½®å·²ä¿å­˜'); }
    async function loadFromDatabase() { try { allConversations = await getAllConversationsFromDb(); filteredConversations = [...allConversations]; if (allConversations.length > 0) { processAllConversations(); document.getElementById('view-upload').style.display = 'none'; if (filteredConversations.length > 0) openConversation(filteredConversations[0].id); } favorites = await getAllFavoritesFromDb(); } catch (e) { console.error('åŠ è½½æ•°æ®å¤±è´¥', e); } }
    function toggleHeaderCollapse() { isHeaderCollapsed = !isHeaderCollapsed; const s = document.getElementById('collapsible-section'), b = document.getElementById('collapse-btn'), t = document.getElementById('timeline-nav'); if (isHeaderCollapsed) { s.classList.add('collapsed'); b.classList.add('collapsed'); t.classList.add('collapsed'); } else { s.classList.remove('collapsed'); b.classList.remove('collapsed'); t.classList.remove('collapsed'); } }
    
    // â˜… åˆ‡æ¢æœç´¢æ¨¡å¼æ—¶ä¿ç•™å…³é”®è¯
    function setSearchMode(mode) {
      searchMode = mode;
      document.querySelectorAll('.search-mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
      document.getElementById('search-input').placeholder = mode === 'global' ? 'å…¨å±€æœç´¢æ¶ˆæ¯å†…å®¹...' : 'æœç´¢å½“å‰å¯¹è¯...';
      
      // å¦‚æœæœ‰å·²è¾“å…¥çš„å…³é”®è¯ï¼Œç«‹å³è§¦å‘æœç´¢
      const keyword = document.getElementById('search-input').value.trim();
      if (keyword) {
        handleSearch();
      } else {
        document.getElementById('global-search-info').classList.remove('show');
        if (mode === 'current' && currentMessages.length > 0) {
          renderMessages(currentMessages);
        }
      }
    }
    
    function handleSearch() {
      const keyword = document.getElementById('search-input').value.toLowerCase().trim();
      currentSearchKeyword = keyword;
      
      if (!keyword) { 
        document.getElementById('global-search-info').classList.remove('show'); 
        if (searchMode === 'current') renderMessages(currentMessages); 
        else { 
          document.getElementById('view-global-search').classList.remove('show'); 
          document.getElementById('view-chat').classList.add('show'); 
        } 
        return; 
      }
      if (searchMode === 'current') performCurrentSearch(keyword); 
      else performGlobalSearch(keyword);
    }
    
    function performCurrentSearch(keyword) {
      const filtered = currentMessages.filter(m => m.content.toLowerCase().includes(keyword));
      flatSearchResults = filtered.map(m => ({ convId: currentConvId, msgId: m.id }));
      currentSearchResultIndex = flatSearchResults.length > 0 ? 0 : -1;
      if (filtered.length > 0) { document.getElementById('search-result-count').textContent = `æ‰¾åˆ° ${filtered.length} æ¡ç»“æœ`; document.getElementById('global-search-info').classList.add('show'); } else { document.getElementById('global-search-info').classList.remove('show'); }
      renderMessages(filtered, null, false, keyword);
      if (currentSearchResultIndex >= 0) highlightCurrentSearchResult();
    }
    
    function performGlobalSearch(keyword) {
      globalSearchResults = []; flatSearchResults = [];
      allConversations.forEach(conv => {
        const messages = parseMessages(conv.mapping, conv.current_node);
        const matches = [];
        messages.forEach(msg => {
          if (msg.content.toLowerCase().includes(keyword)) {
            const preview = generatePreview(msg.content, keyword);
            matches.push({ msgId: msg.id, content: msg.content, preview: preview, time: msg.time, role: msg.role });
            flatSearchResults.push({ convId: conv.id, convTitle: conv.title || 'æœªå‘½åå¯¹è¯', msgId: msg.id });
          }
        });
        if (matches.length > 0) globalSearchResults.push({ convId: conv.id, convTitle: conv.title || 'æœªå‘½åå¯¹è¯', matchCount: matches.length, matches: matches });
      });
      currentSearchResultIndex = flatSearchResults.length > 0 ? 0 : -1;
      const totalMatches = flatSearchResults.length, convCount = globalSearchResults.length;
      document.getElementById('search-result-count').textContent = `æ‰¾åˆ° ${totalMatches} æ¡ç»“æœï¼Œåˆ†å¸ƒåœ¨ ${convCount} ä¸ªå¯¹è¯ä¸­`;
      document.getElementById('global-search-info').classList.add('show');
      renderGlobalSearchResults(keyword);
      document.getElementById('view-chat').classList.remove('show');
      document.getElementById('view-global-search').classList.add('show');
      document.getElementById('global-search-stats').textContent = `å…± ${totalMatches} æ¡åŒ¹é…ï¼Œæ¥è‡ª ${convCount} ä¸ªå¯¹è¯`;
    }
    
    function generatePreview(content, keyword) { const lc = content.toLowerCase(), idx = lc.indexOf(keyword.toLowerCase()); if (idx === -1) return content.substring(0, 100); const start = Math.max(0, idx - 30), end = Math.min(content.length, idx + keyword.length + 50); let p = ''; if (start > 0) p += '...'; p += content.substring(start, end); if (end < content.length) p += '...'; return p; }
    
    function renderGlobalSearchResults(keyword) {
      const container = document.getElementById('global-search-results');
      if (globalSearchResults.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¶ˆæ¯~</p></div>'; return; }
      container.innerHTML = globalSearchResults.map(r => {
        const fm = r.matches[0], hp = highlightKeywordInText(escapeHtml(fm.preview), keyword);
        return `<div class="search-result-item" onclick="jumpToSearchResult('${r.convId}', '${fm.msgId}', '${escapeJsString(keyword)}')"><div class="search-result-conv-title">ğŸ“š ${escapeHtml(r.convTitle)}<span class="search-result-count-badge">${r.matchCount} å¤„åŒ¹é…</span></div><div class="search-result-preview">${hp}</div><div class="search-result-meta">${fm.role === 'user' ? 'ğŸ§¸ ç”¨æˆ·' : 'ğŸ¤– AI'} Â· ${fm.time ? formatFullDateTime(fm.time) : ''}</div></div>`;
      }).join('');
    }
    
    // â˜… æ–°å¢ï¼šå®‰å…¨è½¬ä¹‰JSå­—ç¬¦ä¸²ç”¨äºonclick
    function escapeJsString(s) {
      return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
    
    function highlightKeywordInText(text, keyword) { if (!keyword) return text; const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'gi'); return text.replace(regex, '<span class="highlight">$1</span>'); }
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    
    // â˜… ä¿®æ”¹ï¼šè·³è½¬åä¿ç•™å…³é”®è¯é«˜äº®ï¼Œå¹¶ä¿®å¤æ»šåŠ¨å®šä½
    function jumpToSearchResult(convId, msgId, keyword) {
      // ä¿å­˜å…³é”®è¯ç”¨äºé«˜äº®æ˜¾ç¤º
      currentSearchKeyword = keyword;
      
      // æ‰“å¼€å¯¹è¯å¹¶ä¼ å…¥å…³é”®è¯è¿›è¡Œé«˜äº®ï¼ŒåŒæ—¶è·³è¿‡æ»šåŠ¨é‡ç½®
      openConversation(convId, keyword, true);
      
      // åˆ‡æ¢è§†å›¾
      document.getElementById('view-global-search').classList.remove('show'); 
      document.getElementById('view-chat').classList.add('show');
      
      // â˜… å¢åŠ å»¶æ—¶ç¡®ä¿DOMæ¸²æŸ“å®Œæˆåå†æ»šåŠ¨
      setTimeout(() => { 
        const el = document.getElementById(`msg-${msgId}`); 
        if (el) { 
          el.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
          el.classList.add('highlight'); 
          setTimeout(() => el.classList.remove('highlight'), 3000); 
        } 
      }, 300);
    }
    
    function navigateSearchResult(dir) {
      if (flatSearchResults.length === 0) return;
      currentSearchResultIndex += dir;
      if (currentSearchResultIndex < 0) currentSearchResultIndex = flatSearchResults.length - 1;
      else if (currentSearchResultIndex >= flatSearchResults.length) currentSearchResultIndex = 0;
      const r = flatSearchResults[currentSearchResultIndex];
      if (searchMode === 'current') highlightCurrentSearchResult(); else jumpToSearchResult(r.convId, r.msgId, document.getElementById('search-input').value);
    }
    
    function highlightCurrentSearchResult() {
      document.querySelectorAll('.message.highlight').forEach(el => el.classList.remove('highlight'));
      if (currentSearchResultIndex < 0 || currentSearchResultIndex >= flatSearchResults.length) return;
      const r = flatSearchResults[currentSearchResultIndex], el = document.getElementById(`msg-${r.msgId}`);
      if (el) { el.classList.add('highlight'); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
      document.getElementById('search-result-count').textContent = `${currentSearchResultIndex + 1} / ${flatSearchResults.length}`;
    }
    
    // â˜… è¿”å›æ—¶ä¿ç•™æœç´¢è¯
    function exitGlobalSearch() { 
      document.getElementById('view-global-search').classList.remove('show'); 
      document.getElementById('view-chat').classList.add('show'); 
      document.getElementById('global-search-info').classList.remove('show'); 
      setSearchMode('current'); 
    }
    
    function setupDragDrop() { const ub = document.getElementById('upload-box'); if (!ub) return; ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => ub.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); })); ub.addEventListener('dragover', () => ub.classList.add('dragover')); ub.addEventListener('dragleave', () => ub.classList.remove('dragover')); ub.addEventListener('drop', e => { ub.classList.remove('dragover'); const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.json')); if (files.length > 0) processFiles(files); }); }
    function handleFileSelect(e) { const files = Array.from(e.target.files); if (files.length > 0) processFiles(files); e.target.value = ''; }
    async function processFiles(files) {
      showLoading('æ­£åœ¨è§£ææ–‡ä»¶...');
      let totalAdded = 0, totalUpdated = 0;
      try {
        for (const file of files) { const r = await processFile(file); totalAdded += r.added; totalUpdated += r.updated; }
        filteredConversations = [...allConversations]; processAllConversations(); document.getElementById('view-upload').style.display = 'none';
        if (filteredConversations.length > 0 && !currentConvId) openConversation(filteredConversations[0].id);
        if (totalAdded > 0 && totalUpdated > 0) showToast(`æ–°å¢ ${totalAdded} ä¸ªå¯¹è¯ï¼Œæ›´æ–° ${totalUpdated} ä¸ªå¯¹è¯`);
        else if (totalAdded > 0) showToast(`æˆåŠŸå¯¼å…¥ ${totalAdded} ä¸ªæ–°å¯¹è¯`);
        else if (totalUpdated > 0) showToast(`æ›´æ–°äº† ${totalUpdated} ä¸ªå¯¹è¯`);
        else showToast('æ²¡æœ‰æ–°å†…å®¹éœ€è¦å¯¼å…¥');
      } catch (err) { console.error('è§£æå¤±è´¥', err); showToast('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®è®¤æ˜¯æœ‰æ•ˆçš„JSONæ–‡ä»¶'); }
      hideLoading();
    }
    async function processFile(file) {
      const text = await readFileAsText(file);
      let data = JSON.parse(text), newConvs = Array.isArray(data) ? data : [data];
      newConvs = newConvs.map(c => { const pid = c.conversation_id || c.id; c.id = pid; c.conversation_id = pid; return c; });
      let addedCount = 0, updatedCount = 0;
      for (const conv of newConvs) {
        const existIdx = allConversations.findIndex(c => c.conversation_id === conv.conversation_id || c.id === conv.id);
        if (existIdx >= 0) { const ex = allConversations[existIdx]; if ((conv.update_time || conv.create_time || 0) >= (ex.update_time || ex.create_time || 0)) { allConversations[existIdx] = conv; await saveConversationToDb(conv); updatedCount++; } }
        else { allConversations.push(conv); await saveConversationToDb(conv); addedCount++; }
      }
      return { added: addedCount, updated: updatedCount };
    }
    function readFileAsText(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result); reader.onerror = () => reject(reader.error); reader.readAsText(file); }); }
    function processAllConversations() {
      allMessages = []; statsByDate = {}; messagesByDate = {}; conversationStats = {};
      allConversations.sort((a, b) => (a.create_time || 0) - (b.create_time || 0));
      filteredConversations = [...allConversations];
      allConversations.forEach((conv, convIndex) => {
        const messages = parseMessages(conv.mapping, conv.current_node);
        let totalChars = 0; messages.forEach(m => totalChars += m.content.length);
        conversationStats[conv.id] = { messageCount: messages.length, totalChars, estimatedTokens: Math.round(totalChars / 2.5) };
        messages.forEach(msg => {
          msg.convIndex = convIndex; msg.convId = conv.id; msg.convTitle = conv.title || `å¯¹è¯ ${convIndex + 1}`;
          allMessages.push(msg);
          if (msg.time) {
            const ds = formatDateKey(msg.time);
            if (!messagesByDate[ds]) messagesByDate[ds] = [];
            messagesByDate[ds].push(msg);
            if (!statsByDate[ds]) statsByDate[ds] = { userWords: 0, aiWords: 0, count: 0 };
            const words = msg.content.length;
            if (msg.role === 'user') statsByDate[ds].userWords += words; else statsByDate[ds].aiWords += words;
            statsByDate[ds].count++;
          }
        });
      });
      renderConversationList(); updateDrawerSubtitle(); renderCalendar(); renderTimeline();
    }
    function parseMessages(mapping, currentNode) {
      if (!mapping) return [];
      const messages = [], seenIds = new Set();
      for (const [nodeId, nodeData] of Object.entries(mapping)) {
        if (!nodeData || !nodeData.message) continue;
        if (seenIds.has(nodeId)) continue;
        const msg = nodeData.message, role = msg.author?.role, contentType = msg.content?.content_type;
        if (contentType === 'user_editable_context') {
          const aboutUser = msg.metadata?.user_context_message_data?.about_user_message || '', aboutModel = msg.metadata?.user_context_message_data?.about_model_message || '';
          let dc = ''; if (aboutUser) dc += `ã€å…³äºç”¨æˆ·ã€‘\n${aboutUser.trim()}\n\n`; if (aboutModel) dc += `ã€è‡ªå®šä¹‰æŒ‡ä»¤ã€‘\n${aboutModel.trim()}`;
          if (dc.trim()) { seenIds.add(nodeId); messages.push({ id: nodeId, role: 'system', type: 'custom_instructions', content: dc.trim(), time: msg.create_time || 0, model: null }); }
          continue;
        }
        if (msg.author?.role === 'tool' && msg.author?.name === 'bio') { const bc = msg.content?.parts?.join('') || ''; if (bc.trim()) { seenIds.add(nodeId); messages.push({ id: nodeId, role: 'memory', type: 'memory_update', content: bc.trim(), time: msg.create_time || 0, model: null }); } continue; }
        if (role === 'assistant' && msg.recipient === 'bio') { const bc = msg.content?.parts?.join('') || ''; if (bc.trim()) { seenIds.add(nodeId); messages.push({ id: nodeId, role: 'memory', type: 'memory_call', content: `ğŸ’¾ å†™å…¥è®°å¿†åº“:\n${bc.trim()}`, time: msg.create_time || 0, model: msg.metadata?.model_slug || null }); } continue; }
        if (msg.metadata?.is_visually_hidden_from_conversation) continue;
        const content = msg.content?.parts?.join('') || '';
        if (!content.trim()) continue;
        if (role === 'user' || role === 'assistant') {
          if (msg.recipient && msg.recipient !== 'all') continue;
          let model = null; if (role === 'assistant') model = msg.metadata?.model_slug || msg.metadata?.default_model_slug || msg.author?.metadata?.model_slug || null;
          seenIds.add(nodeId); messages.push({ id: nodeId, role, type: 'normal', content, time: msg.create_time || 0, model });
        }
      }
      messages.sort((a, b) => (a.time || 0) - (b.time || 0));
      const deduped = []; for (const m of messages) { if (!deduped.some(x => x.time === m.time && x.content === m.content && x.role === m.role)) deduped.push(m); }
      return deduped;
    }
    function renderConversationList() {
      const container = document.getElementById('drawer-conversations');
      if (filteredConversations.length === 0) { container.innerHTML = allConversations.length === 0 ? '<div class="empty-state"><div class="icon">ğŸ“­</div><p>ä¸Šä¼ JSONåè¿™é‡Œä¼šæ˜¾ç¤ºå¯¹è¯åˆ—è¡¨~</p></div>' : '<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¯¹è¯</p></div>'; return; }
      container.innerHTML = filteredConversations.map(conv => {
        const isActive = currentConvId === conv.id, isSelected = selectedConvIds.has(conv.id), stats = conversationStats[conv.id] || { messageCount: 0, estimatedTokens: 0 }, escapedTitle = escapeHtml(conv.title || 'æœªå‘½åå¯¹è¯');
        let timeRange = ''; if (conv.create_time) { const cd = formatDateCompact(conv.create_time); if (conv.update_time && conv.update_time !== conv.create_time) { const ud = formatDateCompact(conv.update_time); timeRange = cd !== ud ? `${cd} ~ ${ud}` : cd; } else timeRange = cd; }
        return `<div class="conv-item ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}" data-conv-id="${conv.id}"><div class="conv-checkbox ${isSelectMode ? 'show' : ''} ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation(); toggleConvSelection('${conv.id}')">${isSelected ? 'âœ“' : ''}</div><div class="conv-info"><div class="conv-title">ğŸ’¬ ${escapedTitle}</div><div class="conv-meta">${timeRange}<br>${stats.messageCount} æ¡æ¶ˆæ¯ Â· ${formatNumber(stats.estimatedTokens)} tokens</div></div><button class="conv-delete-btn" onclick="event.stopPropagation(); showDeleteConvModal('${conv.id}', '${escapedTitle.replace(/'/g, "\\'")}')">Ã—</button></div>`;
      }).join('');
      container.querySelectorAll('.conv-item').forEach(item => { item.addEventListener('click', function() { const convId = this.dataset.convId; if (isSelectMode) toggleConvSelection(convId); else openConversation(convId); }); });
    }
    function toggleSelectMode() { isSelectMode = !isSelectMode; selectedConvIds.clear(); const btn = document.getElementById('select-mode-btn'), eb = document.getElementById('export-selected-btn'), db = document.getElementById('delete-selected-btn'); if (isSelectMode) { btn.classList.add('active'); btn.innerHTML = 'âœ“ å–æ¶ˆ'; eb.style.display = 'flex'; db.style.display = 'flex'; } else { btn.classList.remove('active'); btn.innerHTML = 'â˜‘ å¤šé€‰'; eb.style.display = 'none'; db.style.display = 'none'; } renderConversationList(); }
    function toggleConvSelection(convId) { if (selectedConvIds.has(convId)) selectedConvIds.delete(convId); else selectedConvIds.add(convId); renderConversationList(); }
    function exportSelectedConversations() { if (selectedConvIds.size === 0) { showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å¯¹è¯'); return; } const sc = allConversations.filter(c => selectedConvIds.has(c.id)), ds = JSON.stringify(sc, null, 2), blob = new Blob([ds], { type: 'application/json' }), url = URL.createObjectURL(blob), a = document.createElement('a'); a.href = url; a.download = `å¯¹è¯å¯¼å‡º_${selectedConvIds.size}ä¸ª_${formatDateForFile(new Date())}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast(`å·²å¯¼å‡º ${selectedConvIds.size} ä¸ªå¯¹è¯`); toggleSelectMode(); }
    function showDeleteConvModal(convId, convTitle) { showModal('ğŸ—‘ï¸', 'åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ã€Œ${convTitle}ã€å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`, async () => { await performDeleteConversation(convId); }, true); }
    function showDeleteSelectedModal() { if (selectedConvIds.size === 0) { showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¯¹è¯'); return; } showModal('ğŸ—‘ï¸', 'æ‰¹é‡åˆ é™¤', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedConvIds.size} ä¸ªå¯¹è¯å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`, async () => { showLoading('æ­£åœ¨åˆ é™¤...'); try { const ids = [...selectedConvIds]; for (const id of ids) { await deleteConversationFromDb(id); allConversations = allConversations.filter(c => c.id !== id); } selectedConvIds.clear(); toggleSelectMode(); processAllConversations(); if (allConversations.length === 0) { document.getElementById('view-upload').style.display = 'flex'; document.getElementById('view-chat').classList.remove('show'); currentConvId = null; } else if (ids.includes(currentConvId)) openConversation(allConversations[0].id); showToast('å·²åˆ é™¤é€‰ä¸­çš„å¯¹è¯'); } catch (e) { console.error('åˆ é™¤å¤±è´¥', e); showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'); } hideLoading(); }, true); }
    async function performDeleteConversation(convId) { showLoading('æ­£åœ¨åˆ é™¤...'); try { await deleteConversationFromDb(convId); allConversations = allConversations.filter(c => c.id !== convId); processAllConversations(); if (allConversations.length === 0) { document.getElementById('view-upload').style.display = 'flex'; document.getElementById('view-chat').classList.remove('show'); currentConvId = null; } else if (currentConvId === convId) openConversation(allConversations[0].id); showToast('å·²åˆ é™¤å¯¹è¯'); } catch (e) { console.error('åˆ é™¤å¤±è´¥', e); showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'); } hideLoading(); }
    function filterConversations() { const kw = document.getElementById('conv-search-input').value.toLowerCase().trim(); filteredConversations = !kw ? [...allConversations] : allConversations.filter(c => (c.title || '').toLowerCase().includes(kw)); renderConversationList(); }
    
    // â˜… ä¿®æ”¹ï¼šopenConversation æ”¯æŒè·³è¿‡æ»šåŠ¨é‡ç½®
    function openConversation(convId, highlightKeyword = null, skipScrollReset = false) { 
      const conv = allConversations.find(c => c.id === convId); 
      if (!conv) return; 
      currentConvId = convId; 
      currentConvIndex = allConversations.indexOf(conv); 
      currentMessages = parseMessages(conv.mapping, conv.current_node); 
      document.getElementById('chat-title').textContent = conv.title || 'æœªå‘½åå¯¹è¯'; 
      
      // å¦‚æœä¼ å…¥äº†é«˜äº®å…³é”®è¯ï¼Œåˆ™ä½¿ç”¨å®ƒ
      const kwToHighlight = highlightKeyword || null;
      renderMessages(currentMessages, null, false, kwToHighlight); 
      
      renderChatTimeline(); 
      renderConversationList(); 
      document.getElementById('view-upload').style.display = 'none'; 
      document.getElementById('view-chat').classList.add('show'); 
      document.getElementById('view-favorites').classList.remove('show'); 
      document.getElementById('view-stats').classList.remove('show'); 
      document.getElementById('view-timeline').classList.remove('show'); 
      document.getElementById('view-day-messages').classList.remove('show'); 
      document.getElementById('view-global-search').classList.remove('show');
      document.getElementById('view-conv-select').classList.remove('show');
      document.querySelectorAll('.drawer-menu-item').forEach(el => el.classList.toggle('active', el.dataset.view === 'conversations')); 
      toggleDrawer(false);
      
      // â˜… åªæœ‰åœ¨éè·³è½¬æ¨¡å¼ä¸‹æ‰é‡ç½®æ»šåŠ¨ä½ç½®
      if (!skipScrollReset) {
        document.getElementById('chat-messages').scrollTop = 0;
      }
    }
    
    function renderMessages(messages, container = null, showConvTitle = false, highlightKw = null) {
      const tc = container || document.getElementById('chat-messages');
      if (messages.length === 0) { tc.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’¬</div><p>æ²¡æœ‰æ¶ˆæ¯~</p></div>'; return; }
      let html = '', lastDate = '', lastConvId = '';
      const userName = appSettings.userName || '', aiName = appSettings.aiName || '';
      messages.forEach(msg => {
        const ds = msg.time ? formatDateKey(msg.time) : '';
        if (showConvTitle && msg.convId !== lastConvId) { html += `<div class="conv-group-title">ğŸ“š ${escapeHtml(msg.convTitle)}</div>`; lastConvId = msg.convId; }
        if (ds && ds !== lastDate) { html += `<div class="date-divider" id="date-${ds}"><span>${formatDate(msg.time)}</span></div>`; lastDate = ds; }
        let dc = escapeHtml(msg.content); if (highlightKw) dc = highlightKeywordInText(dc, highlightKw);
        if (msg.type === 'custom_instructions') { html += `<div class="message system" id="msg-${msg.id}" data-date="${ds}"><div class="message-avatar-wrapper"><div class="message-avatar">âš™ï¸</div></div><div class="message-body"><div class="message-bubble"><span class="system-label">ğŸ“‹ çª—å£è‡ªå®šä¹‰æŒ‡ä»¤</span><div style="white-space: pre-wrap;">${dc}</div></div></div></div>`; }
        else if (msg.type === 'memory_update' || msg.type === 'memory_call') { html += `<div class="message memory" id="msg-${msg.id}" data-date="${ds}"><div class="message-avatar-wrapper"><div class="message-avatar">ğŸ§ </div></div><div class="message-body"><div class="message-bubble"><span class="memory-label">ğŸ’¾ è®°å¿†åº“æ“ä½œ</span><div style="white-space: pre-wrap;">${dc}</div></div><div class="message-footer"><span class="message-time">${msg.time ? formatFullDateTime(msg.time) : ''}</span></div></div></div>`; }
        else { const isFav = favorites.has(msg.id), mb = msg.model ? `<span class="message-model">${formatModelName(msg.model)}</span>` : '', an = msg.role === 'user' ? userName : aiName; html += `<div class="message ${msg.role}" id="msg-${msg.id}" data-date="${ds}"><div class="message-avatar-wrapper"><div class="message-avatar">${msg.role === 'user' ? 'ğŸ§¸' : 'ğŸ¤–'}</div>${an ? `<span class="avatar-name">${escapeHtml(an)}</span>` : ''}</div><div class="message-body"><div class="message-bubble">${dc}</div><div class="message-footer"><span class="message-time">${msg.time ? formatFullDateTime(msg.time) : ''}</span>${mb}<button class="star-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${msg.id}', this)">${isFav ? 'â­' : 'â˜†'}</button></div></div></div>`; }
      });
      tc.innerHTML = html;
    }
    function formatModelName(m) { const mm = { 'gpt-4': 'GPT-4', 'gpt-4o': 'GPT-4o', 'gpt-4o-mini': 'GPT-4o mini', 'gpt-4-turbo': 'GPT-4 Turbo', 'gpt-3.5-turbo': 'GPT-3.5', 'text-davinci-002-render-sha': 'GPT-3.5', 'gpt-4-gizmo': 'GPT-4 (GPTs)', 'o1-preview': 'o1-preview', 'o1-mini': 'o1-mini' }; return mm[m] || m; }
    function renderChatTimeline() { const nav = document.getElementById('timeline-nav'), dates = [...new Set(currentMessages.filter(m => m.time).map(m => formatDateKey(m.time)))]; if (dates.length <= 1) { nav.classList.remove('show'); return; } nav.innerHTML = dates.map(d => `<button class="timeline-btn" onclick="scrollToDate('${d}')">${formatDateShort(d)}</button>`).join(''); nav.classList.add('show'); }
    function scrollToDate(ds) { const d = document.getElementById(`date-${ds}`); if (d) d.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    async function toggleFavorite(msgId, btn) { if (favorites.has(msgId)) { favorites.delete(msgId); await removeFavoriteFromDb(msgId); btn.classList.remove('active'); btn.textContent = 'â˜†'; } else { favorites.add(msgId); await saveFavoriteToDb(msgId); btn.classList.add('active'); btn.textContent = 'â­'; } }
    function toggleFavSelectMode() { isFavSelectMode = !isFavSelectMode; selectedFavMsgIds.clear(); const btn = document.getElementById('fav-select-btn'), sab = document.getElementById('fav-select-all-btn'), ub = document.getElementById('fav-unfav-all-btn'), eb = document.getElementById('fav-export-btn'); if (isFavSelectMode) { btn.classList.add('active'); btn.innerHTML = 'âœ“ å–æ¶ˆ'; sab.style.display = 'inline-flex'; ub.style.display = 'inline-flex'; eb.style.display = 'inline-flex'; } else { btn.classList.remove('active'); btn.innerHTML = 'â˜‘ å¤šé€‰'; sab.style.display = 'none'; ub.style.display = 'none'; eb.style.display = 'none'; } renderFavorites(); }
    function toggleFavMsgSelection(msgId) { if (selectedFavMsgIds.has(msgId)) selectedFavMsgIds.delete(msgId); else selectedFavMsgIds.add(msgId); renderFavorites(); }
    function selectAllFavorites() { const fm = allMessages.filter(m => favorites.has(m.id)); if (selectedFavMsgIds.size === fm.length) selectedFavMsgIds.clear(); else fm.forEach(m => selectedFavMsgIds.add(m.id)); renderFavorites(); }
    async function unfavoriteSelected() { if (selectedFavMsgIds.size === 0) { showToast('è¯·å…ˆé€‰æ‹©è¦å–æ¶ˆæ”¶è—çš„æ¶ˆæ¯'); return; } showModal('ğŸ—‘ï¸', 'å–æ¶ˆæ”¶è—', `ç¡®å®šè¦å–æ¶ˆæ”¶è—é€‰ä¸­çš„ ${selectedFavMsgIds.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`, async () => { showLoading('æ­£åœ¨å–æ¶ˆæ”¶è—...'); try { for (const id of selectedFavMsgIds) { favorites.delete(id); await removeFavoriteFromDb(id); } const cnt = selectedFavMsgIds.size; selectedFavMsgIds.clear(); renderFavorites(); showToast(`å·²å–æ¶ˆæ”¶è— ${cnt} æ¡æ¶ˆæ¯`); } catch (e) { console.error('å–æ¶ˆæ”¶è—å¤±è´¥', e); showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•'); } hideLoading(); }, true); }
    function exportSelectedFavorites() { if (selectedFavMsgIds.size === 0) { showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ¶ˆæ¯'); return; } const sm = allMessages.filter(m => selectedFavMsgIds.has(m.id)); let et = `# æ”¶è—çš„æ¶ˆæ¯å¯¼å‡º\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\nå…± ${sm.length} æ¡æ¶ˆæ¯\n\n---\n\n`; let lct = ''; sm.forEach(m => { if (m.convTitle !== lct) { et += `## ğŸ“š ${m.convTitle}\n\n`; lct = m.convTitle; } const r = m.role === 'user' ? 'ğŸ¦œ æˆ‘' : 'ğŸ¤– AI', t = m.time ? formatFullDateTime(m.time) : ''; et += `### ${r} ${t}\n\n${m.content}\n\n---\n\n`; }); const blob = new Blob([et], { type: 'text/markdown;charset=utf-8' }), url = URL.createObjectURL(blob), a = document.createElement('a'); a.href = url; a.download = `æ”¶è—æ¶ˆæ¯å¯¼å‡º_${selectedFavMsgIds.size}æ¡_${formatDateForFile(new Date())}.md`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast(`å·²å¯¼å‡º ${selectedFavMsgIds.size} æ¡æ”¶è—æ¶ˆæ¯`); toggleFavSelectMode(); }
    function renderFavorites() { const c = document.getElementById('favorites-list'); if (favorites.size === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">â­</div><p>è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ¶ˆæ¯~<br>åœ¨èŠå¤©ä¸­ç‚¹å‡»â˜†æ¥æ”¶è—å§</p></div>'; return; } const fm = allMessages.filter(m => favorites.has(m.id)); if (fm.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">â­</div><p>æ”¶è—çš„æ¶ˆæ¯æš‚æ—¶æ— æ³•æ˜¾ç¤º<br>å¯èƒ½å¯¹è¯æ•°æ®è¿˜æœªåŠ è½½</p></div>'; return; } const un = appSettings.userName || '', an = appSettings.aiName || ''; c.innerHTML = fm.map(m => { const isSel = selectedFavMsgIds.has(m.id), mb = m.model ? `<span class="message-model">${formatModelName(m.model)}</span>` : '', avn = m.role === 'user' ? un : an; return `<div class="message ${m.role}" style="display: flex; align-items: flex-start;"><div class="fav-msg-checkbox ${isFavSelectMode ? 'show' : ''} ${isSel ? 'checked' : ''}" onclick="toggleFavMsgSelection('${m.id}')">${isSel ? 'âœ“' : ''}</div><div class="message-avatar-wrapper"><div class="message-avatar">${m.role === 'user' ? 'ğŸ§¸' : 'ğŸ¤–'}</div>${avn ? `<span class="avatar-name">${escapeHtml(avn)}</span>` : ''}</div><div class="message-body"><div class="message-bubble">${escapeHtml(m.content)}</div><div class="message-footer"><span class="message-time">${escapeHtml(m.convTitle)} Â· ${m.time ? formatFullDateTime(m.time) : ''}</span>${mb}<button class="star-btn active" onclick="toggleFavorite('${m.id}', this); setTimeout(renderFavorites, 100);">â­</button></div></div></div>`; }).join(''); }
    function renderCalendar() { const c = document.getElementById('calendar-days'); document.getElementById('month-label').textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`; const fd = new Date(currentYear, currentMonth, 1).getDay(), dim = new Date(currentYear, currentMonth + 1, 0).getDate(); let html = '', mtw = 0, mad = 0; for (let i = 0; i < fd; i++) html += '<div class="calendar-day empty"></div>'; for (let d = 1; d <= dim; d++) { const ds = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`, st = statsByDate[ds]; let hc = '', wl = ''; if (st) { const tw = st.userWords + st.aiWords; mtw += tw; mad++; wl = formatWordCount(tw); if (tw < 5000) hc = 'heat-1'; else if (tw < 20000) hc = 'heat-2'; else if (tw < 50000) hc = 'heat-3'; else hc = 'heat-4'; } html += `<div class="calendar-day ${hc}" onclick="showDayMessages('${ds}')"><span class="day-num">${d}</span>${wl ? `<span class="day-words">${wl}</span>` : ''}</div>`; } c.innerHTML = html; document.getElementById('stat-total-words').textContent = formatWordCount(mtw); document.getElementById('stat-total-days').textContent = mad + 'å¤©'; }
    function changeMonth(d) { currentMonth += d; if (currentMonth < 0) { currentMonth = 11; currentYear--; } else if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); }
    
    // â˜… ä¿®æ”¹ï¼šshowDayMessages ç°åœ¨æ˜¾ç¤ºçª—å£é€‰æ‹©é¡µé¢
    function showDayMessages(ds) { 
      const dm = messagesByDate[ds]; 
      if (!dm || dm.length === 0) { 
        showToast('è¿™å¤©æ²¡æœ‰æ¶ˆæ¯'); 
        return; 
      }
      
      // æŒ‰çª—å£IDåˆ†ç»„ï¼Œç»Ÿè®¡æ¯ä¸ªçª—å£åœ¨è¿™å¤©çš„æ¶ˆæ¯æ•°
      const convMap = new Map();
      dm.forEach(msg => {
        if (!convMap.has(msg.convId)) {
          convMap.set(msg.convId, {
            convId: msg.convId,
            convTitle: msg.convTitle,
            messageCount: 0,
            userCount: 0,
            aiCount: 0
          });
        }
        const info = convMap.get(msg.convId);
        info.messageCount++;
        if (msg.role === 'user') info.userCount++;
        else if (msg.role === 'assistant') info.aiCount++;
      });
      
      const convList = Array.from(convMap.values());
      
      // è®¾ç½®æ ‡é¢˜
      document.getElementById('conv-select-title').textContent = formatDateFromKey(ds);
      document.getElementById('conv-select-subtitle').textContent = `å…± ${convList.length} ä¸ªå¯¹è¯çª—å£ï¼Œ${dm.length} æ¡æ¶ˆæ¯`;
      
      // æ¸²æŸ“çª—å£åˆ—è¡¨
      const container = document.getElementById('conv-select-list');
      container.innerHTML = convList.map(conv => {
        return `<div class="conv-select-item" onclick="showConvMessagesForDate('${ds}', '${conv.convId}')">
          <div class="conv-icon">ğŸ’¬</div>
          <div class="conv-detail">
            <div class="conv-name">${escapeHtml(conv.convTitle)}</div>
            <div class="conv-stats">${conv.messageCount} æ¡æ¶ˆæ¯ Â· ç”¨æˆ· ${conv.userCount} æ¡ Â· AI ${conv.aiCount} æ¡</div>
          </div>
          <div class="conv-arrow">â€º</div>
        </div>`;
      }).join('');
      
      // ä¿å­˜å½“å‰é€‰æ‹©çš„æ—¥æœŸï¼Œä¾›è¿”å›æ—¶ä½¿ç”¨
      window.currentSelectedDate = ds;
      
      switchView('conv-select'); 
    }

    // â˜… æ–°å¢ï¼šæ˜¾ç¤ºæŒ‡å®šçª—å£åœ¨æŒ‡å®šæ—¥æœŸçš„æ¶ˆæ¯
    function showConvMessagesForDate(ds, convId) {
      const dm = messagesByDate[ds];
      if (!dm || dm.length === 0) {
        showToast('æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯');
        return;
      }
      
      // ç­›é€‰å‡ºè¯¥çª—å£åœ¨è¯¥æ—¥æœŸçš„æ¶ˆæ¯
      const filteredMessages = dm.filter(msg => msg.convId === convId);
      
      if (filteredMessages.length === 0) {
        showToast('è¯¥çª—å£åœ¨è¿™å¤©æ²¡æœ‰æ¶ˆæ¯');
        return;
      }
      
      // æŒ‰æ—¶é—´æ’åº
      filteredMessages.sort((a, b) => (a.time || 0) - (b.time || 0));
      
      // è·å–çª—å£æ ‡é¢˜
      const convTitle = filteredMessages[0].convTitle || 'æœªå‘½åå¯¹è¯';
      
      document.getElementById('day-messages-title').textContent = `${formatDateFromKey(ds)}`;
      document.getElementById('day-messages-subtitle').textContent = `${convTitle} Â· å…± ${filteredMessages.length} æ¡æ¶ˆæ¯`;
      
      renderMessages(filteredMessages, document.getElementById('day-messages-container'), false);
      
      // ä¿å­˜çŠ¶æ€ä¾›è¿”å›ä½¿ç”¨
      window.currentSelectedDate = ds;
      window.currentSelectedConvId = convId;
      
      switchView('day-messages');
    }

    // â˜… æ–°å¢ï¼šä»æ¶ˆæ¯è¯¦æƒ…é¡µè¿”å›åˆ°çª—å£é€‰æ‹©é¡µ
    function backToConvSelect() {
      if (window.currentSelectedDate) {
        showDayMessages(window.currentSelectedDate);
      } else {
        switchView('timeline');
      }
    }
    
    function renderTimeline() { const c = document.getElementById('timeline-list'), dates = Object.keys(statsByDate).sort().reverse(); if (dates.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“…</div><p>è¿˜æ²¡æœ‰å¯¹è¯æ•°æ®~</p></div>'; return; } c.innerHTML = dates.map(d => { const st = statsByDate[d], total = st.userWords + st.aiWords; return `<div class="timeline-date-item" onclick="showDayMessages('${d}')"><span class="date">${formatDateFromKey(d)}</span><span class="count">${st.count}æ¡æ¶ˆæ¯ Â· ${formatWordCount(total)}</span></div>`; }).join(''); }
    
    // â˜… ä¿®æ”¹ï¼šswitchView æ–°å¢ conv-select è§†å›¾
    function switchView(view) { 
      document.querySelectorAll('.drawer-menu-item').forEach(el => el.classList.toggle('active', el.dataset.view === view)); 
      document.getElementById('view-upload').style.display = 'none'; 
      document.getElementById('view-chat').classList.remove('show'); 
      document.getElementById('view-favorites').classList.remove('show'); 
      document.getElementById('view-stats').classList.remove('show'); 
      document.getElementById('view-timeline').classList.remove('show'); 
      document.getElementById('view-day-messages').classList.remove('show'); 
      document.getElementById('view-global-search').classList.remove('show'); 
      document.getElementById('view-conv-select').classList.remove('show');
      switch(view) { 
        case 'conversations': 
          if (currentConvId) document.getElementById('view-chat').classList.add('show'); 
          else if (allConversations.length > 0) openConversation(allConversations[0].id); 
          else document.getElementById('view-upload').style.display = 'flex'; 
          break; 
        case 'chat': 
          document.getElementById('view-chat').classList.add('show'); 
          break; 
        case 'favorites': 
          document.getElementById('view-favorites').classList.add('show'); 
          renderFavorites(); 
          break; 
        case 'stats': 
          document.getElementById('view-stats').classList.add('show'); 
          break; 
        case 'timeline': 
          document.getElementById('view-timeline').classList.add('show'); 
          break; 
        case 'day-messages': 
          document.getElementById('view-day-messages').classList.add('show'); 
          break; 
        case 'conv-select':
          document.getElementById('view-conv-select').classList.add('show');
          break;
      } 
      toggleDrawer(false); 
    }
    
    function toggleDrawer(show) { const d = document.getElementById('drawer'), o = document.getElementById('drawer-overlay'); if (typeof show === 'undefined') show = !d.classList.contains('show'); d.classList.toggle('show', show); o.classList.toggle('show', show); }
    function updateDrawerSubtitle() { const s = document.getElementById('drawer-subtitle'); s.textContent = allConversations.length > 0 ? `${allConversations.length} ä¸ªå¯¹è¯ Â· ${allMessages.length} æ¡æ¶ˆæ¯` : 'è¿˜æ²¡æœ‰ä¸Šä¼ å¯¹è¯å“¦~'; }
    function showModal(icon, title, message, onConfirm, isDanger = false) { document.getElementById('modal-icon').textContent = icon; document.getElementById('modal-title').textContent = title; document.getElementById('modal-message').textContent = message; document.getElementById('modal-confirm-btn').className = isDanger ? 'modal-btn confirm' : 'modal-btn primary'; modalConfirmCallback = onConfirm; document.getElementById('modal-overlay').classList.add('show'); }
    function closeModal() { document.getElementById('modal-overlay').classList.remove('show'); modalConfirmCallback = null; }
    async function confirmModalAction() { if (modalConfirmCallback) { const cb = modalConfirmCallback; closeModal(); await cb(); } }
    function showClearDataModal() { showModal('âš ï¸', 'æ¸…é™¤æ‰€æœ‰æ•°æ®', 'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ\nè¿™å°†åˆ é™¤æ‰€æœ‰å¯¹è¯å’Œæ”¶è—ï¼Œæ— æ³•æ¢å¤ï¼', async () => { showLoading('æ­£åœ¨æ¸…é™¤æ•°æ®...'); try { await clearAllDataFromDb(); allConversations = []; filteredConversations = []; allMessages = []; messagesByDate = {}; favorites = new Set(); statsByDate = {}; conversationStats = {}; currentConvId = null; currentConvIndex = -1; currentMessages = []; renderConversationList(); updateDrawerSubtitle(); document.getElementById('view-upload').style.display = 'flex'; document.getElementById('view-chat').classList.remove('show'); toggleDrawer(false); showToast('å·²æ¸…é™¤æ‰€æœ‰æ•°æ®'); } catch (e) { console.error('æ¸…é™¤å¤±è´¥', e); showToast('æ¸…é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'); } hideLoading(); }, true); }
    function showLoading(text) { document.getElementById('loading-text').textContent = text || 'åŠ è½½ä¸­...'; document.getElementById('loading-overlay').classList.add('show'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.remove('show'); }
    function showToast(message) { const t = document.getElementById('toast'); t.textContent = message; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    function formatDate(ts) { return new Date(ts * 1000).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }); }
    function formatDateCompact(ts) { const d = new Date(ts * 1000); return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`; }
    function formatFullDateTime(ts) { const d = new Date(ts * 1000); return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }
    function formatDateKey(ts) { const d = new Date(ts * 1000); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
    function formatDateShort(ds) { const [y, m, d] = ds.split('-'); return `${parseInt(m)}/${parseInt(d)}`; }
    function formatDateFromKey(ds) { const [y, m, d] = ds.split('-'); return `${y}å¹´${parseInt(m)}æœˆ${parseInt(d)}æ—¥`; }
    function formatDateForFile(d) { return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`; }
    function formatWordCount(c) { if (c >= 10000) return (c / 10000).toFixed(1) + 'w'; if (c >= 1000) return (c / 1000).toFixed(1) + 'k'; return c.toString(); }
    function formatNumber(n) { if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M'; if (n >= 1000) return (n / 1000).toFixed(1) + 'k'; return n.toString(); }
    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
  </script>
</body>
</html>
